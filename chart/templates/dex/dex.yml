apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dex
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: exphost
  source:
    repoURL: 'https://charts.dexidp.io'
    targetRevision: 0.8.2
    chart: dex
    helm:
      values: |
        configSecret:
          create: false
          name: dex-config
        ingress:
          enabled: true
          hosts:
            - host: auth.{{ .Values.domain }}
              paths:
                - path: /dex
                  pathType: ImplementationSpecific
          tls:
            - hosts:
                - auth.{{ .Values.domain }}
              secretName: dex-acme.tls
          annotations:
            cert-manager.io/cluster-issuer: acme-issuer
            nginx.ingress.kubernetes.io/enable-cors: "true"
            nginx.ingress.kubernetes.io/cors-allow-methods: "PUT, GET, POST, OPTIONS"
            nginx.ingress.kubernetes.io/cors-allow-origin: "*"
            nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
        priorityClassName: high-priority
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: dex
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
